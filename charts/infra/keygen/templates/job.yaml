{{- if .Values.openbao.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "keygen.fullname" . }}-to-openbao
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "30"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: keygen
          image: "{{ .Values.image.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          env:
            - name: VAULT_ADDR
              value: {{ .Values.openbao.address | quote }}
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openbao-bootstrap
                  key: root-token

          command:
            - /bin/sh
            - -ec
            - |
              echo "Running keygen..."
              OUTPUT="$(/entrypoint.sh || true)"

              if [ -z "$OUTPUT" ]; then
                echo "ERROR: keygen returned empty output"
                exit 1
              fi

              echo "Keygen output: $OUTPUT"

              API_KEY=$(echo "$OUTPUT" | jq -r '.api_key')
              HMAC_SALT=$(echo "$OUTPUT" | jq -r '.hmac_salt')

              if [ "$API_KEY" = "null" ] || [ "$HMAC_SALT" = "null" ]; then
                echo "ERROR: invalid JSON from keygen"
                exit 1
              fi

              echo "Writing secrets to OpenBao..."

              curl -sSf \
                -H "X-Vault-Token: $VAULT_TOKEN" \
                -H "Content-Type: application/json" \
                -X POST \
                $VAULT_ADDR/v1/secret/data/keygen \
                -d @- <<EOF
              {
                "data": {
                  "api_key": "$API_KEY",
                  "hmac_salt": "$HMAC_SALT"
                }
              }
              EOF

              echo "Secrets stored successfully"
{{- end }}
