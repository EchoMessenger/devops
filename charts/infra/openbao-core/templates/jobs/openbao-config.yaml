apiVersion: batch/v1
kind: Job
metadata:
  name: openbao-config
  namespace: {{ .Release.Namespace }}
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        {{- include "openbao.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: config
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openbao.serviceAccountName" . }}-bootstrap
      containers:
        - name: config
          image: bitnami/kubectl:latest
          command: ["/bin/sh", "-c"]
          env:
            - name: BAO_ADDR
              value: "http://{{ include "openbao.fullname" . }}:{{ .Values.service.port }}"
          args:
            - |
              set -e

              echo "=== OpenBao Config Job ==="
              echo "Configuring secrets engines, audit, and namespaces"
              echo ""

              # ============================================
              # 1. Wait for OpenBao to be UNSEALED
              # ============================================
              echo "Waiting for OpenBao API..."
              until curl -s $BAO_ADDR/v1/sys/health >/dev/null 2>&1; do
                sleep 2
              done

              # ============================================
              # 2. Get root token
              # ============================================
              echo ""
              echo "Getting root token..."
              
              MAX_WAIT=60
              WAITED=0
              
              while true; do
                ROOT_TOKEN=$(kubectl get secret openbao-bootstrap -n {{ .Release.Namespace }} \
                  -o jsonpath='{.data.root-token}' 2>/dev/null | base64 -d 2>/dev/null || echo "")

                if [ -n "$ROOT_TOKEN" ] && [ "$ROOT_TOKEN" != "null" ] && [ "$ROOT_TOKEN" != "" ]; then
                  echo "Root token acquired"
                  break
                fi
                
                echo "Waiting for root token..."
                sleep 5
                WAITED=$((WAITED + 5))
                if [ $WAITED -ge $MAX_WAIT ]; then
                  echo "ERROR: Root token not found!"
                  exit 1
                fi
              done

              # Test authentication
              echo "Testing authentication..."
              AUTH_TEST=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" $BAO_ADDR/v1/sys/mounts)
              if echo "$AUTH_TEST" | jq -e '.errors' >/dev/null 2>&1; then
                echo "ERROR: Authentication failed!"
                echo "$AUTH_TEST" | jq .
                exit 1
              fi
              echo "Authentication OK"

              # ============================================
              # 3. Enable KV Secrets Engine
              # ============================================
              echo ""
              echo "=== Configuring KV Secrets Engine ==="

              MOUNTS=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" $BAO_ADDR/v1/sys/mounts)

              # KV v2 at secret/
              if echo "$MOUNTS" | jq -e '.["secret/"]' >/dev/null 2>&1; then
                echo "✓ KV v2 already enabled at secret/"
              else
                echo "Enabling KV v2 at secret/..."
                RESULT=$(curl -s -X POST \
                  -H "X-Vault-Token: $ROOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"type":"kv","options":{"version":"2"},"description":"Key-Value secrets engine v2"}' \
                  $BAO_ADDR/v1/sys/mounts/secret)

                if echo "$RESULT" | jq -e '.errors' >/dev/null 2>&1; then
                  echo "ERROR: Failed to enable KV engine!"
                  echo "$RESULT" | jq .
                  exit 1
                fi
                echo "✓ KV v2 enabled at secret/"
              fi

              # KV v2 at apps/
              if echo "$MOUNTS" | jq -e '.["apps/"]' >/dev/null 2>&1; then
                echo "✓ KV v2 already enabled at apps/"
              else
                echo "Enabling KV v2 at apps/..."
                RESULT=$(curl -s -X POST \
                  -H "X-Vault-Token: $ROOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"type":"kv","options":{"version":"2"},"description":"Application secrets"}' \
                  $BAO_ADDR/v1/sys/mounts/apps)

                if echo "$RESULT" | jq -e '.errors' >/dev/null 2>&1; then
                  echo "ERROR: Failed to enable apps KV engine!"
                  echo "$RESULT" | jq .
                  exit 1
                fi
                echo "✓ KV v2 enabled at apps/"
              fi

              # ============================================
              # 4. Enable Transit Secrets Engine
              # ============================================
              echo ""
              echo "=== Configuring Transit Secrets Engine ==="

              # Refresh mounts
              MOUNTS=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" $BAO_ADDR/v1/sys/mounts)

              if echo "$MOUNTS" | jq -e '.["transit/"]' >/dev/null 2>&1; then
                echo "✓ Transit engine already enabled"
              else
                echo "Enabling Transit engine..."
                RESULT=$(curl -s -X POST \
                  -H "X-Vault-Token: $ROOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"type":"transit","description":"Encryption as a Service"}' \
                  $BAO_ADDR/v1/sys/mounts/transit)

                if echo "$RESULT" | jq -e '.errors' >/dev/null 2>&1; then
                  echo "ERROR: Failed to enable Transit engine!"
                  echo "$RESULT" | jq .
                  exit 1
                fi
                echo "✓ Transit engine enabled"

                # Create default encryption key
                echo "Creating default encryption key..."
                curl -s -X POST \
                  -H "X-Vault-Token: $ROOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"type":"aes256-gcm96"}' \
                  $BAO_ADDR/v1/transit/keys/default >/dev/null 2>&1 || true
                echo "✓ Default encryption key created"
              fi

              # ============================================
              # 5. Enable Audit Logging (optional, may fail)
              # ============================================
              echo ""
              echo "=== Configuring Audit Logging ==="

              AUDITS=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" $BAO_ADDR/v1/sys/audit)

              if echo "$AUDITS" | jq -e '.["file/"]' >/dev/null 2>&1; then
                echo "✓ Audit logging already enabled"
              else
                echo "Enabling file audit device..."
                # Note: This may fail if /vault/audit doesn't exist - that's OK
                RESULT=$(curl -s -X PUT \
                  -H "X-Vault-Token: $ROOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"type":"file","options":{"file_path":"/vault/audit/audit.log"}}' \
                  $BAO_ADDR/v1/sys/audit/file)

                if echo "$RESULT" | jq -e '.errors' >/dev/null 2>&1; then
                  echo "⚠ Warning: Could not enable file audit (path may not exist)"
                  echo "  This is OK - audit can be configured later"
                else
                  echo "✓ File audit logging enabled"
                fi
              fi

              # ============================================
              # 6. Create Demo Secret
              # ============================================
              echo ""
              echo "=== Creating Demo Secret ==="

              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d '{"data":{"username":"demo-user","password":"demo-password-change-me","created_by":"openbao-config-job"}}' \
                $BAO_ADDR/v1/secret/data/demo)

              if echo "$RESULT" | jq -e '.errors' >/dev/null 2>&1; then
                echo "⚠ Warning: Could not create demo secret"
              else
                echo "✓ Demo secret created at secret/demo"
              fi

              # ============================================
              # 7. Final Verification
              # ============================================
              echo ""
              echo "=== Final Verification ==="

              echo "Secrets Engines:"
              MOUNTS=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" $BAO_ADDR/v1/sys/mounts)
              for mount in secret/ apps/ transit/; do
                if echo "$MOUNTS" | jq -e --arg m "$mount" '.[$m]' >/dev/null 2>&1; then
                  TYPE=$(echo "$MOUNTS" | jq -r --arg m "$mount" '.[$m].type')
                  echo "  ✓ $mount ($TYPE)"
                else
                  echo "  ✗ $mount - NOT FOUND"
                fi
              done

              echo ""
              echo "Transit Keys:"
              KEYS=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" "$BAO_ADDR/v1/transit/keys?list=true")
              if echo "$KEYS" | jq -e '.data.keys' >/dev/null 2>&1; then
                echo "$KEYS" | jq -r '.data.keys[] | "  ✓ " + .'
              else
                echo "  (no keys or transit not enabled)"
              fi

              echo ""
              echo "========================================="
              echo "=== OpenBao Configuration Complete! ==="
              echo "========================================="
              echo ""
              echo "Enabled:"
              echo "  ✓ KV v2 at secret/"
              echo "  ✓ KV v2 at apps/"
              echo "  ✓ Transit encryption"
              echo ""
              echo "Your OpenBao is ready for production use!"
              
              exit 0