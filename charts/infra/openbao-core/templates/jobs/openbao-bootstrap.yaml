apiVersion: batch/v1
kind: Job
metadata:
  name: openbao-bootstrap
  namespace: openbao
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: bitnami/kubectl:latest
          command: ["/bin/sh", "-c"]
          env:
            - name: BAO_ADDR
              value: "http://openbao:8200"
          args:
            - |
              set -e

              echo "=== OpenBao Bootstrap Job ==="

              # 1. Ждём API
              echo "Waiting for OpenBao API..."
              until curl -s $BAO_ADDR/v1/sys/health >/dev/null 2>&1; do
                sleep 2
              done

              # 2. Ждём unseal
              echo "Waiting for unseal..."
              until [ "$(curl -s $BAO_ADDR/v1/sys/seal-status | jq -r .sealed)" = "false" ]; do
                echo "Still sealed, waiting..."
                sleep 5
              done
              echo "OpenBao is unsealed!"

              # 3. Получаем root token
              echo "Getting root token..."
              ROOT_TOKEN=$(kubectl get secret openbao-bootstrap -n openbao \
                -o jsonpath='{.data.root-token}' | base64 -d)

              if [ -z "$ROOT_TOKEN" ] || [ "$ROOT_TOKEN" = "null" ]; then
                echo "ERROR: Root token not found!"
                exit 1
              fi
              echo "Root token acquired"

              # 4. Проверяем что можем аутентифицироваться
              echo "Testing authentication..."
              AUTH_TEST=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" $BAO_ADDR/v1/sys/auth)
              if echo "$AUTH_TEST" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: Authentication failed!"
                echo "$AUTH_TEST" | jq .
                exit 1
              fi
              echo "Authentication OK"

              # ============================================
              # 5. Enable Kubernetes Auth Method
              # ============================================
              echo ""
              echo "=== Configuring Kubernetes Auth ==="

              # Проверяем, включен ли уже
              K8S_AUTH=$(curl -s -H "X-Vault-Token: $ROOT_TOKEN" \
                $BAO_ADDR/v1/sys/auth | jq -r '.["kubernetes/"]')

              if [ "$K8S_AUTH" = "null" ]; then
                echo "Enabling Kubernetes auth..."
                curl -s -X POST \
                  -H "X-Vault-Token: $ROOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"type": "kubernetes"}' \
                  $BAO_ADDR/v1/sys/auth/kubernetes
                echo "Kubernetes auth enabled"
              else
                echo "Kubernetes auth already enabled"
              fi

              # Конфигурируем Kubernetes auth
              echo "Configuring Kubernetes auth..."

              # Получаем данные кластера
              K8S_HOST="https://kubernetes.default.svc"
              
              # Read CA cert into a variable, properly escaped for JSON
              K8S_CA_CERT=$(cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)

              # Create JSON payload using jq to handle escaping properly
              K8S_CONFIG=$(jq -n \
                --arg host "$K8S_HOST" \
                --arg ca "$K8S_CA_CERT" \
                '{kubernetes_host: $host, kubernetes_ca_cert: $ca}')

              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$K8S_CONFIG" \
                $BAO_ADDR/v1/auth/kubernetes/config)

              if echo "$RESULT" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: Kubernetes auth configuration failed!"
                echo "$RESULT" | jq .
                exit 1
              fi

              echo "Kubernetes auth configured"

              # ============================================
              # 6. Create Policies
              # ============================================
              echo ""
              echo "=== Creating Policies ==="

              # Policy: admin (full access)
              echo "Creating admin policy..."
              cat > /tmp/admin-policy.hcl <<'EOF'
path "*" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
EOF

              ADMIN_POLICY_JSON=$(jq -n --arg policy "$(cat /tmp/admin-policy.hcl)" '{policy: $policy}')
              
              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$ADMIN_POLICY_JSON" \
                $BAO_ADDR/v1/sys/policies/acl/admin)

              if echo "$RESULT" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: Admin policy creation failed!"
                echo "$RESULT" | jq .
                exit 1
              fi
              echo "Admin policy created"

              # Policy: read-only (для мониторинга)
              echo "Creating readonly policy..."
              cat > /tmp/readonly-policy.hcl <<'EOF'
path "sys/health" {
  capabilities = ["read"]
}
path "sys/seal-status" {
  capabilities = ["read"]
}
path "secret/data/*" {
  capabilities = ["read", "list"]
}
path "secret/metadata/*" {
  capabilities = ["read", "list"]
}
EOF

              READONLY_POLICY_JSON=$(jq -n --arg policy "$(cat /tmp/readonly-policy.hcl)" '{policy: $policy}')

              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$READONLY_POLICY_JSON" \
                $BAO_ADDR/v1/sys/policies/acl/readonly)

              if echo "$RESULT" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: Readonly policy creation failed!"
                echo "$RESULT" | jq .
                exit 1
              fi
              echo "Readonly policy created"

              # Policy: app-default (базовая для приложений)
              echo "Creating app-default policy..."
              cat > /tmp/app-default-policy.hcl <<'EOF'
path "secret/data/{{identity.entity.aliases.auth_kubernetes_*.metadata.service_account_namespace}}/*" {
  capabilities = ["read", "list"]
}
path "secret/data/shared/*" {
  capabilities = ["read", "list"]
}
EOF

              APP_POLICY_JSON=$(jq -n --arg policy "$(cat /tmp/app-default-policy.hcl)" '{policy: $policy}')

              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$APP_POLICY_JSON" \
                $BAO_ADDR/v1/sys/policies/acl/app-default)

              if echo "$RESULT" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: App-default policy creation failed!"
                echo "$RESULT" | jq .
                exit 1
              fi
              echo "App-default policy created"

              # ============================================
              # 7. Create Kubernetes Auth Roles
              # ============================================
              echo ""
              echo "=== Creating Kubernetes Auth Roles ==="

              # Role: default (для любого сервиса в namespace)
              echo "Creating default role..."
              DEFAULT_ROLE=$(jq -n '{
                bound_service_account_names: ["*"],
                bound_service_account_namespaces: ["default", "apps", "staging", "production"],
                policies: ["app-default"],
                ttl: "1h",
                max_ttl: "24h"
              }')

              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$DEFAULT_ROLE" \
                $BAO_ADDR/v1/auth/kubernetes/role/default)

              if echo "$RESULT" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: Default role creation failed!"
                echo "$RESULT" | jq .
                exit 1
              fi
              echo "Default role created"

              # Role: admin (для openbao namespace)
              echo "Creating admin role..."
              ADMIN_ROLE=$(jq -n '{
                bound_service_account_names: ["openbao-admin"],
                bound_service_account_namespaces: ["openbao"],
                policies: ["admin"],
                ttl: "1h",
                max_ttl: "4h"
              }')

              RESULT=$(curl -s -X POST \
                -H "X-Vault-Token: $ROOT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$ADMIN_ROLE" \
                $BAO_ADDR/v1/auth/kubernetes/role/admin)

              if echo "$RESULT" | jq -e .errors >/dev/null 2>&1; then
                echo "ERROR: Admin role creation failed!"
                echo "$RESULT" | jq .
                exit 1
              fi
              echo "Admin role created"

              # ============================================
              # 8. Verify Setup
              # ============================================
              echo ""
              echo "=== Verifying Setup ==="

              echo "Auth methods:"
              curl -s -H "X-Vault-Token: $ROOT_TOKEN" \
                $BAO_ADDR/v1/sys/auth | jq -r 'to_entries | map(.key) | .[]'

              echo ""
              echo "Policies:"
              curl -s -H "X-Vault-Token: $ROOT_TOKEN" \
                $BAO_ADDR/v1/sys/policies/acl | jq -r '.keys | .[]'

              echo ""
              echo "Kubernetes roles:"
              curl -s -H "X-Vault-Token: $ROOT_TOKEN" \
                $BAO_ADDR/v1/auth/kubernetes/role?list=true | jq -r '.data.keys | .[]'

              echo ""
              echo "=== Bootstrap Complete! ==="

      serviceAccountName: openbao-bootstrap