apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.service.name | default (include "openbao.fullname" .) }}-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "openbao.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "openbao.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      restartPolicy: OnFailure
      serviceAccountName: openbao-bootstrap
      containers:
        - name: init
          image: bitnami/kubectl:latest
          command: ["/bin/sh","-c"]
          env:
            - name: BAO_ADDR
              value: {{ quote .Values.openbao.server }}
          args:
            - |
              set -e

              echo "Waiting for OpenBao API..."
              until curl -s $BAO_ADDR/v1/sys/health >/dev/null; do
                sleep 2
              done

              echo "Checking init status..."
              INIT=$(curl -s $BAO_ADDR/v1/sys/init | jq -r .initialized)

              if [ "$INIT" = "true" ]; then
                echo "Already initialized"
                exit 0
              fi

              echo "Initializing OpenBao via API..."

              INIT_PAYLOAD='{
                "secret_shares": 3,
                "secret_threshold": 2
              }'

              curl -s -X POST $BAO_ADDR/v1/sys/init \
                -H "Content-Type: application/json" \
                -d "$INIT_PAYLOAD" > /tmp/init.json

              # Для отладки - показать структуру ответа
              echo "API Response structure:"
              cat /tmp/init.json | jq 'keys'

              ROOT=$(jq -r .root_token /tmp/init.json)
              # Исправлено: keys_base64 вместо keys_b64
              K1=$(jq -r '.keys_base64[0]' /tmp/init.json)
              K2=$(jq -r '.keys_base64[1]' /tmp/init.json)
              K3=$(jq -r '.keys_base64[2]' /tmp/init.json)

              echo "Storing secrets in k8s..."

              kubectl -n openbao patch secret openbao-bootstrap \
                --type merge \
                -p "{\"stringData\":{
                  \"root-token\":\"$ROOT\",
                  \"unseal-key-1\":\"$K1\",
                  \"unseal-key-2\":\"$K2\",
                  \"unseal-key-3\":\"$K3\"
                }}"

              echo "Init done"
