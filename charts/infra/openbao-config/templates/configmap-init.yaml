{{- if .Values.init.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openbao-config.fullname" . }}-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openbao-config.labels" . | nindent 4 }}
data:
  init.sh: |
    #!/bin/sh
    set -e

    export BAO_ADDR='{{ include "openbao-config.serverAddr" . }}'

    echo "=== Waiting for OpenBao to be ready ==="
    until bao status 2>/dev/null | grep -q "Sealed.*false"; do
      echo "Waiting for OpenBao to be unsealed..."
      sleep 5
    done

    echo "=== Logging in ==="
    bao login "$BAO_TOKEN"

    echo "=== Enabling secrets engines ==="
{{- range .Values.secretsEngines }}
    bao secrets enable -path={{ .path }} {{ .type }} 2>/dev/null || echo "Secrets engine {{ .path }} already enabled"
{{- end }}

{{- if .Values.init.kubernetesAuth.enabled }}
    echo "=== Configuring Kubernetes auth ==="
    bao auth enable -path={{ .Values.init.kubernetesAuth.path }} kubernetes 2>/dev/null || echo "Kubernetes auth already enabled"

    bao write auth/{{ .Values.init.kubernetesAuth.path }}/config \
      kubernetes_host="https://kubernetes.default.svc:443" \
      kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
{{- end }}

    echo "=== Creating policies ==="
{{- range $nsName, $nsConfig := .Values.namespaces }}
{{- if $nsConfig.enabled }}
{{- range $policy := $nsConfig.policies }}
    cat <<'POLICY_EOF' | bao policy write {{ $policy.name }} -
{{ $policy.rules | indent 6 }}
POLICY_EOF
{{- end }}
{{- end }}
{{- end }}

    echo "=== Creating roles ==="
{{- range $nsName, $nsConfig := .Values.namespaces }}
{{- if $nsConfig.enabled }}
{{- range $role := $nsConfig.roles }}
    bao write auth/{{ $.Values.init.kubernetesAuth.path }}/role/{{ $role.name }} \
      bound_service_account_names={{ join "," $role.boundServiceAccountNames }} \
      bound_service_account_namespaces={{ join "," $role.boundServiceAccountNamespaces }} \
      policies={{ join "," $role.policies }} \
      ttl={{ $role.ttl }}
{{- end }}
{{- end }}
{{- end }}

    echo "=== Verification ==="
    echo "Auth methods:"
    bao auth list

    echo "Policies:"
    bao policy list

    echo "Kubernetes roles:"
    bao list auth/{{ .Values.init.kubernetesAuth.path }}/role

    echo "=== OpenBao initialization complete (secrets are NOT created by Helm) ==="
{{- end }}