# values-prometheus-stack.yaml

prometheus:
  prometheusSpec:
    retention: 15d
    enableRemoteWriteReceiver: true
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi
    # Автоматически находить все ServiceMonitor и PodMonitor
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    # Ресурсы для одноузлового кластера
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 2Gi

grafana:
  adminPassword: "" # set via --set grafana.adminPassword=...
  persistence:
    enabled: true
    size: 5Gi
  additionalDataSources:
    - name: Loki
      type: loki
      access: proxy
      url: http://loki-gateway.monitoring.svc.cluster.local:80
      jsonData:
        derivedFields:
          - name: TraceID
            datasourceUid: tempo
            matcherRegex: '"traceId":"(\w+)"'
            url: '$${__value.raw}'
    - name: Tempo
      type: tempo
      access: proxy
      uid: tempo
      url: http://tempo.monitoring.svc.cluster.local:3100
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'custom'
          folder: 'Custom'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/custom
  # Готовые дашборды из grafana.com
  dashboards:
    default:
      # Node Exporter Full
      node-exporter:
        gnetId: 1860
        revision: 37
        datasource: Prometheus
      # Kubernetes cluster monitoring
      k8s-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      # Kafka (Strimzi)
      strimzi-kafka:
        gnetId: 11285
        revision: 1
        datasource: Prometheus
      # PostgreSQL
      postgresql:
        gnetId: 9628
        revision: 7
        datasource: Prometheus
      # Traefik
      traefik:
        gnetId: 17346
        revision: 9
        datasource: Prometheus
      # CoreDNS
      coredns:
        gnetId: 15463
        revision: 2
        datasource: Prometheus
      # Cert-Manager
      cert-manager:
        gnetId: 20842
        revision: 3
        datasource: Prometheus

  ingress:
    enabled: true
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - www.grafana.echo-messenger.ru
    tls:
      - secretName: grafana-tls
        hosts:
          - www.grafana.echo-messenger.ru

# Node exporter для метрик хоста
nodeExporter:
  enabled: true

# Kube-state-metrics для метрик объектов K8s
kubeStateMetrics:
  enabled: true

# Правила алертинга
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # K3s использует встроенный etcd/sqlite
    configReloaders: true
    general: true
    k8sContainerCpuUsageSecondsTotal: true
    k8sContainerMemoryWorkingSetBytes: true
    k8sPodOwner: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: false  # K3s
    kubeProxy: false              # K3s
    kubeSchedulerAlerting: false  # K3s
    kubeSchedulerRecording: false # K3s
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true