# values-prometheus-stack.yaml

prometheus:
  prometheusSpec:
    retention: 15d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –≤—Å–µ ServiceMonitor –∏ PodMonitor
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    # –†–µ—Å—É—Ä—Å—ã –¥–ª—è –æ–¥–Ω–æ—É–∑–ª–æ–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 2Gi
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ scrape targets
    additionalScrapeConfigs:
      # Traefik –º–µ—Ç—Ä–∏–∫–∏
      - job_name: 'traefik'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['kube-system']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            regex: traefik
            action: keep
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: '${1}:9100'

grafana:
  adminPassword: "" # set via --set grafana.adminPassword=...
  persistence:
    enabled: true
    size: 5Gi
  additionalDataSources:
    - name: Loki
      type: loki
      access: proxy
      url: http://loki-gateway.monitoring.svc.cluster.local:80
      jsonData:
        derivedFields:
          - name: TraceID
            datasourceUid: tempo
            matcherRegex: '"traceId":"(\w+)"'
            url: '$${__value.raw}'
    - name: Tempo
      type: tempo
      access: proxy
      uid: tempo
      url: http://tempo.monitoring.svc.cluster.local:3100
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'custom'
          folder: 'Custom'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/custom
  # –ì–æ—Ç–æ–≤—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –∏–∑ grafana.com
  dashboards:
    default:
      # Node Exporter Full
      node-exporter:
        gnetId: 1860
        revision: 37
        datasource: Prometheus
      # Kubernetes cluster monitoring
      k8s-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      # Kafka (Strimzi)
      strimzi-kafka:
        gnetId: 11285
        revision: 1
        datasource: Prometheus
      # PostgreSQL
      postgresql:
        gnetId: 9628
        revision: 7
        datasource: Prometheus
      # Traefik
      traefik:
        gnetId: 17346
        revision: 9
        datasource: Prometheus
      # CoreDNS
      coredns:
        gnetId: 15463
        revision: 2
        datasource: Prometheus
      # Cert-Manager
      cert-manager:
        gnetId: 20842
        revision: 3
        datasource: Prometheus

  ingress:
    enabled: true
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - www.grafana.echo-messenger.ru
    tls:
      - secretName: grafana-tls
        hosts:
          - www.grafana.echo-messenger.ru

# alertmanager:
#   alertmanagerSpec:
#     storage:
#       volumeClaimTemplate:
#         spec:
#           accessModes: ["ReadWriteOnce"]
#           resources:
#             requests:
#               storage: 2Gi
#   # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
#   config:
#     global:
#       resolve_timeout: 5m
#     route:
#       receiver: 'telegram'
#       group_by: ['alertname', 'namespace']
#       group_wait: 30s
#       group_interval: 5m
#       repeat_interval: 4h
#       routes:
#         - receiver: 'critical-telegram'
#           match:
#             severity: critical
#           repeat_interval: 1h
#     receivers:
#       - name: 'telegram'
#         telegram_configs:
#           - bot_token: 'YOUR_BOT_TOKEN'
#             chat_id: YOUR_CHAT_ID
#             parse_mode: 'HTML'
#             message: |
#               {{ range .Alerts }}
#               <b>{{ .Labels.alertname }}</b>
#               <b>Severity:</b> {{ .Labels.severity }}
#               <b>Namespace:</b> {{ .Labels.namespace }}
#               <b>Description:</b> {{ .Annotations.description }}
#               {{ end }}
#       - name: 'critical-telegram'
#         telegram_configs:
#           - bot_token: 'YOUR_BOT_TOKEN'
#             chat_id: YOUR_CHAT_ID
#             parse_mode: 'HTML'
#             message: |
#               üî¥ <b>CRITICAL</b>
#               {{ range .Alerts }}
#               <b>{{ .Labels.alertname }}</b>
#               <b>Description:</b> {{ .Annotations.description }}
#               {{ end }}

# Node exporter –¥–ª—è –º–µ—Ç—Ä–∏–∫ —Ö–æ—Å—Ç–∞
nodeExporter:
  enabled: true

# Kube-state-metrics –¥–ª—è –º–µ—Ç—Ä–∏–∫ –æ–±—ä–µ–∫—Ç–æ–≤ K8s
kubeStateMetrics:
  enabled: true

# –ü—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # K3s –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π etcd/sqlite
    configReloaders: true
    general: true
    k8sContainerCpuUsageSecondsTotal: true
    k8sContainerMemoryWorkingSetBytes: true
    k8sPodOwner: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: false  # K3s
    kubeProxy: false              # K3s
    kubeSchedulerAlerting: false  # K3s
    kubeSchedulerRecording: false # K3s
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true