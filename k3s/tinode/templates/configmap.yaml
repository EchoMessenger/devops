apiVersion: v1
kind: ConfigMap
metadata:
  name: tinode-config
  namespace: tinode
data:
  tinode.conf: |
    {
      "listen": ":6060",
      "api_path": "/",
      "static_mount": "/",
      "expvar": "/debug/vars",
      "use_x_forwarded_for": true,
      "x_frame_options": "SAMEORIGIN",

      "api_key_salt": "${TINODE_API_KEY_SALT}",
      "max_message_size": 131072,
      "max_subscriber_count": 128,
      "max_tag_count": 16,
      "p2p_delete_enabled": true,
      "msg_delete_age": 600,

      "tls": {
        "enabled": false,
        "http_redirect": ":80"
      },

      "auth_config": {
        "basic": {
          "add_to_tags": true,
          "min_login_length": 4,
          "min_password_length": 6
        },
        "token": {
          "expire_in": 1209600,
          "serial_num": 1,
          "key": "${TINODE_TOKEN_KEY}"
        }
      },

      "store_config": {
        "uid_key": "${TINODE_UID_KEY}",
        "use_adapter": "postgres",
        "adapters": {
          "postgres": {
            "User": "${POSTGRES_USER}",
            "Passwd": "${POSTGRES_PASSWORD}",
            "Host": "{{ .Values.postgres.host }}",
            "Port": "{{ .Values.postgres.port }}",
            "DBName": "${POSTGRES_DB}",
            "SSLMode": "{{ .Values.postgres.sslMode }}"
            "max_open_conns": 50,
            "max_idle_conns": 50,
            "conn_max_lifetime": 60,
            "sql_timeout": 10
          }
        }
      },

      "push": [
        {
          // Notificator which writes to STDOUT. Useful for debugging.
          "name":"stdout",
          "config": {
            // Disabled.
            "enabled": false
          }
        }
      ],

      "media": {
        "use_handler": "fs",
        "max_size": 8388608,
        "gc_period": 60,
        "gc_block_size": 100,
        "handlers": {
          "fs": {
            "upload_dir": "uploads"
          }
        }
      },

      "plugins": [
        {
          // Enable or disable this plugin.
          "enabled": true,

          // Name of the plugin, must be unique.
          "name": "router",

          // Timeout in microseconds.
          "timeout": 20000,

          // Events to send to the plugin.
          "filters": {
            // Account creation events.
            "account": "C"
          },

          // Error code to use in case plugin has failed; 0 means to ignore the failures.
          "failure_code": 0,

          // Text of an error message to report in case of plugin failure.
          "failure_text": "ERR | router | Router has failed. Continuing...",

          // Address of the plugin.
          "service_addr": "tcp://localhost:7911"
        }
      ]
    }
  init-db.sh: |
    #!/bin/sh
    set -e

    echo "Waiting for PostgreSQL to start..."
    until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do
      sleep 1
    done

    echo "Checking if database exists and is initialized..."
    if ! psql -h postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT 1 FROM kvmeta WHERE key='version';" >/dev/null 2>&1; then
      echo "Database not initialized. Creating schema..."
      /app/tinode -config=/tinode.conf -data=/app/tinode-static/data.json -reset=true
    fi

    echo "Starting main application..."
    exec /app/tinode -config=/tinode.conf
